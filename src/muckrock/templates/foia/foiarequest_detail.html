
{% extends "foia/base.html" %}
{% load pingback_tags %}

{% block title %} {{object.title}} {% endblock %}

{% block content %}
	<h1>FOI Request</h1>
	<h2>{{object.title}}</h2>
	<p>Requested by <a href="{% url acct-profile object.user.username %}">{{object.user.username}}</a>
	{% if object.date_submitted %} on {{object.date_submitted|date}}{%endif%}
	for the {{object.agency}} of {{object.jurisdiction}}
	{% if object.date_done %} and fufilled on {{object.date_done|date}}{%endif%}
	</p>
	{% if object.is_embargo and not object.embargo_date %}
	<p class="notice">
	This request is embargoed and will not be visible to others until 30 days after a response is received.
	</p>
	{% endif %}
	{% if object.is_embargo and object.embargo_date %}
	<p class="notice">
	This request is embargoed and will not be visible until {{ object.embargo_date|date }}.
	</p>
	{% endif %}
	<div id="progressbar" title="{{object.percent_complete}}% Complete"></div>
	<p>Status: <span class="request-{{object.color_code}}">
		{{object.get_status_display}}{% if object.date_due and object.status == "processed" %},
		{% if past_due %}
			past due by {{ object.date_due|timesince }}
		{% else %}
			due in {{ object.date_due|timeuntil }}
		{% endif %}
		{%endif%}
	</span></p>

	{% if object.files.all %}
	<h4>Attached Files:</h4>
	<ul>
		{% for file in object.files.all %}
		<li><a href="/static/{{file.ffile.name}}">{{file.name}}</a></li>
		{% endfor %}
	</ul>
	{% endif %}

	{% if object.public_documents or object.user == user%}
	<div id="tabs">
		<ul>
			{% if object.public_documents %}
			<li><a href="#tabs-documents">Documents</a></li>
			{% endif %}
			<li><a href="#tabs-request">Request</a></li>
			{% if object.user == user %}
			<li><a href="#tabs-notes">Notes</a></li>
			{% endif %}
		</ul>
	{% endif %}

	{% if object.public_documents %}
		<div id="tabs-documents">
			<div id="viewer"></div>
			<script src="http://s3.documentcloud.org/viewer/loader.js" type="text/javascript"></script>
			<script type="text/javascript">
				function display_doc(doc_id)
				{
					$("#tabs").tabs("select", "tabs-documents");
					DV.load('http://www.documentcloud.org/documents/' + doc_id + '.js', {
						width: 627,
						height: 600,
						sidebar: false,
						container: "#viewer"
					});

					var embed_code = '<div id="viewer-' + doc_id + '"></div>\n<script src="http://s3.documentcloud.org/viewer/loader.js"><\/script>\n<script>\nDV.load("http://www.documentcloud.org/documents/' + doc_id + '.js", {\n  width: 627,\n  height: 600,\n  sidebar: false,\n  container: "#viewer-' + doc_id + '"});\n<\/script>';
					$('textarea#embed').val(embed_code);
					$('div[id^="rodeo-"]').hide();
					$('#rodeo-' + doc_id).show();
				}

				$(function() {
					var hash = window.location.hash.substring(1);
					var default_doc_id = "{{object.public_documents.0.doc_id}}"
					var documents = [ {%for doc in object.public_documents%}"{{doc.doc_id}}", {%endfor%} ]

					if (!hash || ($.inArray(hash, documents) == -1)) {
						doc_id = default_doc_id;
					} else {
						doc_id = hash;
					}
					if (hash.substring(0,4) != "tabs") display_doc(doc_id);
				});

			</script>
			<div class="dc-thumbnails">

				<ul class="dc-thumbnails">
				{% if object.public_documents|length > 1 %}
					{% for document in object.public_documents %}
						<li><a href="#{{document.doc_id}}" onclick="display_doc('{{document.doc_id}}'); return true"><img src="{{document.get_thumbnail}}" alt="{{document.title}}" title="{{document.title}}" class="tipTip" /></a></li>
					{% endfor %}
				{% endif %}
				</ul>
			</div>
		</div>
		{% endif %}
		<div id="tabs-request">
			{% for comm in communications %}
			<div class="{% if comm.response %}response{% else %}request{% endif %}">
				<strong>From {{comm.from_who}} on {{comm.date|date}}:</strong><br />
				{% if comm.get_thumbnail %}
					{% if comm.access == "public" %}
						<div class="left text-center">
							<a href="#{{comm.doc_id}}" onclick="display_doc('{{comm.doc_id}}'); return true"><img src="{{comm.get_medium_thumbnail}}" alt="{{comm.title}}" title="{{comm.title}}" class="doc-thumb bordered" /></a><br />
							<a href="#{{comm.doc_id}}" onclick="display_doc('{{comm.doc_id}}'); return true">View</a> |
							<a href="/static/{{comm.document}}">Download</a>
						</div>
					{% else %}
						<div class="left text-center">
							<img src="{{comm.get_medium_thumbnail}}" alt="{{comm.title}}" title="{{comm.title}}" class="doc-thumb bordered" /><br />
							<a href="/static/{{comm.document}}">Download</a>
						</div>
					{% endif %}
				{% endif %}
				{% if comm.full_html %}
					{% autoescape off %}{{comm.communication}}{% endautoescape %}
				{% else %}
					{{comm.communication|urlize|linebreaks}}
				{% endif %}
				<div class="clearer">&nbsp;</div>
			</div>
			{% endfor %}
		</div>
		{% if object.user == user %}
		<div id="tabs-notes">
			{% for note in object.notes.all %}
				<div class="note">
					<strong>{{note.date|date}}:</strong><br />
					{{note.note|linebreaks}}
				</div>
			{% empty %}
				<p>You don't have any notes on this request.  Note can be used to store private information regarding this request.</p>
			{% endfor %}
			<p><a class="jqbutton" href="{% url foia-note jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Add a Note</a></p>
		</div>
		{% endif %}
	{% if object.public_documents or object.user == user %}
	</div>
	{% endif %}

{% endblock %}

{% block sidebar %}
	{% if object.sidebar_html %}
		{{ object.sidebar_html|safe }}
		<div class="content-separator"></div>
	{% endif %}
	{% if user == object.user or object.public_documents %}
		<h2>Actions</h2>
		{% if user == object.user %}
			{% if object.is_editable %}
				<p><a class="jqbutton" href="{% url foia-update jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Update</a></p>
			{% else %}
				<p><a class="jqbutton" href="{% url foia-embargo jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Update Embargo</a></p>
			{% endif %}
			{% if object.is_deletable %}
				<p><a class="jqbutton" href="{% url foia-delete jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Delete</a></p>
			{% endif %}
			{% if object.is_fixable %}
				<p><a class="jqbutton" href="{% url foia-fix jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Fix</a></p>
			{% endif %}
			{% if object.is_appealable %}
				<p><a class="jqbutton" href="{% url foia-appeal jurisdiction=object.jurisdiction.slug,idx=object.id,slug=object.slug %}">Appeal</a></p>
			{% endif %}
		{% endif %}
		{% if object.public_documents %}
			<p><a href="#" id="opener" class="jqbutton">Embed this Document</a></p>
			<div id="dialog" title="Embed Code">
				<p>Copy and paste this code into your site to embed this document<p>
				<textarea id="embed" style="width: 520px; height: 160px">
				</textarea>
			</div>
		{% endif %}
		<div class="content-separator"></div>
	{% endif %}

	{% for doc in object.public_documents.all %}
		{% if doc.rodeo_set.all %}
			<div id="rodeo-{{doc.doc_id}}" style="display: none;">
				<h2>Help to Analyze</h2>
				<ul>
					{% for rodeo in doc.rodeo_set.all %}
						<li><a href="{{rodeo.get_absolute_url}}">{{rodeo.title}}</a></li>
					{% endfor %}
				</ul>
			</div>
		{% endif %}
	{% endfor %}

	{% get_pingback_list for object as pingbacks %}
	{% if pingbacks %}
	    <h2>News & Opinions:</h2>
	    {% for pingback in pingbacks %}
	        <div class="b-pingback">
						<strong><a href="{{pingback.url}}">{{ pingback.title|striptags|safe }}</a></strong><br />
						<em>{{ pingback.date|date }}</em><br />
	
						<p>{{ pingback.content|striptags|safe }}</p>
	        </div>
	    {% endfor %}
		<div class="content-separator"></div>
	{% endif %}

{% endblock %}
