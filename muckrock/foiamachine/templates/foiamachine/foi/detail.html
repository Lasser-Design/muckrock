{% extends 'foiamachine/base.html' %}

{% load hosts %}
{% load markdown_deux_tags %}

{% block main %}
<main>
    <header class="space-between align-bottom">
        <div>
            <h1>{{object.title}}</h1>
            <p>{% if object.agency %}<a href="{{object.agency.get_absolute_url}}">{{object.agency}}</a> &bull; {% endif %}<a href="{{object.jurisdiction.get_absolute_url}}">{{object.jurisdiction}}</a></p>
        </div>
        <p><a href="{% host_url 'foi-update' slug=object.slug pk=object.pk host 'foiamachine'%}">Edit</a> &bull; <a href="{% host_url 'foi-delete' slug=object.slug pk=object.pk host 'foiamachine'%}">Delete</a></p>
    </header>
    {% with object.agency as agency %}
    {% if agency %}
    <div class="agency margin-bottom">
        <h2>Contacts</h2>
        <table class="ruled">
            <tbody>
                {% if agency.email %}
                {% with object.communications.first as first_comm %}
                <tr>
                    <td class="bold top">Email</td>
                    <td class="select-all"><a href="mailto:{{agency.email}}?subject={{object.title}}&body={{first_comm.message|urlencode}}">{{agency.email}}</a></td>
                </tr>
                {% endwith %}
                {% endif %}
                {% if agency.phone %}
                <tr>
                    <td class="bold top">Phone</td>
                    <td>{{object.agency.phone}}</td>
                </tr>
                {% endif %}
                {% if agency.address %}
                <tr>
                    <td class="bold top">Address</td>
                    <td><address>{{object.agency.address|linebreaks}}</address></td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
    {% endif %}
    {% endwith %}
    <div class="communications">
        <header class="space-between align-center margin-bottom">
            <h2 class="nomargin">Communications</h2>
            <a href="{% host_url 'comm-create' foi_slug=object.slug foi_pk=object.pk host 'foiamachine' %}">Add a communication</a>
        </header>
        {% for communication in object.communications.all %}
        {% if communication.received %}
        <div class="received communication">
        {% else %}
        <div class="sent communication">
        {% endif %}
            <header class="small space-between align-top">
                <table>
                    {% if communication.receiver %}
                    <tr>
                        <td class="bold">To</td>
                        <td>{{communication.receiver}}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="bold">From</td>
                        <td>{{communication.sender}}</td>
                    </tr>
                    <tr>
                        <td class="bold">Date</td>
                        <td>{{communication.date|date:"F d, Y"}}</td>
                    </tr>
                </table>
                <p class="nomargin"><a href="{% host_url 'comm-update' foi_slug=object.slug foi_pk=object.pk pk=communication.pk host 'foiamachine' %}">Edit</a></p>
            </header>
            <div class="communication__message">
                {{communication.message|markdown}}
            </div>
        </div>
        {% endfor %}
    </div>
</main>
{% endblock %}
