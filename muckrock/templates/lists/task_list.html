{% extends 'lists/base_list.html' %}

{% load tags %}

{% block title %}MuckRock &bull; Tasks{% endblock title %}
{% block type %}task{% endblock type %}

{% block list-sections %}
<section class="list-sections">
    <ul>
        <li class="{% active request '^/task/$' %}">
            <span class="counter">{{ counters.all }}</span>
            <a href="{% url 'task-list' %}">All</a>
        </li>
        <li class="{% active request '^/task/orphan/$' %}">
            <span class="counter">{{ counters.orphan }}</span>
            <a href="{% url 'orphan-task-list' %}">Orphan</a>
        </li>
        <li class="{% active request '^/task/snail-mail/$' %}">
            <span class="counter">{{ counters.snail_mail }}</span>
            <a href="{% url 'snail-mail-task-list' %}">Snail Mail</a>
        </li>
        <li class="{% active request '^/task/rejected-email/$' %}">
            <span class="counter">{{ counters.rejected }}</span>
            <a href="{% url 'rejected-email-task-list' %}">Rejected Email</a>
        </li>
        <li class="{% active request '^/task/stale-agency/$' %}">
            <span class="counter">{{ counters.stale_agency }}</span>
            <a href="{% url 'stale-agency-task-list' %}">Stale Agency</a>
        </li>
        <li class="{% active request '^/task/flagged/$' %}">
            <span class="counter">{{ counters.flagged }}</span>
            <a href="{% url 'flagged-task-list' %}">Flagged</a>
        </li>
        <li class="{% active request '^/task/new-agency/$' %}">
            <span class="counter">{{ counters.new_agency }}</span>
            <a href="{% url 'new-agency-task-list' %}">New Agency</a>
        </li>
        <li class="{% active request '^/task/response/$' %}">
            <span class="counter">{{ counters.response }}</span>
            <a href="{% url 'response-task-list' %}">Response</a>
        </li>
        <li class="{% active request '^/task/payment/$' %}">
            <span class="counter">{{ counters.payment }}</span>
            <a href="{% url 'payment-task-list' %}">Payment</a>
        </li>
        <li class="{% active request '^/task/crowdfund/$' %}">
            <span class="counter">{{ counters.crowdfund }}</span>
            <a href="{% url 'crowdfund-task-list' %}">Crowdfund</a>
        </li>
        <li class="{% active request '^/task/multirequest/$' %}">
            <span class="counter">{{ counters.multirequest }}</span>
            <a href="{% url 'multirequest-task-list' %}">Multi-Request</a>
        </li>
        <li class="{% active request '^/task/status-change/$' %}">
            <span class="counter">{{ counters.status_change }}</span>
            <a href="{% url 'status-change-task-list' %}">Status Change</a>
        </li>
        <li class="{% active request '^/task/failed-fax/$' %}">
            <span class="counter">{{ counters.failed_fax }}</span>
            <a href="{% url 'failed-fax-task-list' %}">Failed Fax</a>
        </li>
    </ul>
</section>
{% endblock %}

{% block list-filters %}
{{ filter_form.show_resolved }}
<label for="id_show_resolved">{{ filter_form.show_resolved.label }}</label>
{% endblock %}

{% block list-content %}
    <section class="list-actions">
        <div>
            <input type="checkbox" id="toggle-all" />
            <label for="toggle_all">Select/Unselect All</label>
        </div>
        <form method="POST" id="batched">
            {% csrf_token %}
            {% if bulk_actions %}
                {% for bulk_action in bulk_actions %}
            <button type="submit" name="{{bulk_action}}" value="true" id="batched-{{bulk_action}}">{{bulk_action|title}}</button>
                {% endfor %}
            {% endif %}
            <button id="collapse-all">Collapse All</button>
        </form>
    </section>
{% if object_list %}
    {% include 'lib/pagination.html' %}
	{% for task in rendered_tasks %}
        {{ task }}
	{% endfor %}
	{% include 'lib/pagination.html' %}
{% endif %}
{% endblock list-content %}

{% block list-scripts %}
var csrftoken = $.cookie('csrftoken');
function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

var tasks = $('.task');
var resolved = $('.resolved.task');

function resolve(taskForm) {
    taskID = '#' + getTaskID($(taskForm).serializeArray()) + '-task';
    taskData = $(taskForm).serialize() + '&resolve=true'
    console.log(taskData);
    $.ajax({
        type: 'POST',
        data: taskData,
        success: markAsResolved(taskID)
    });
}

function reject(taskForm) {
    taskData = $(taskForm).serializeArray()
    taskID = '#' + getTaskID(taskData) + '-task';
    console.log($(taskForm).serialize());
    console.log(taskID);
    $.ajax({
        type: 'POST',
        data: 'resolve=true&task=' + getTaskID(taskData),
        success: markAsResolved(taskID)
    });
}

function getTaskID(taskFormData) {
    // Gets the task ID from a task form
    var taskID;
    $.each(taskFormData, function(i, input){
        if (input.name == 'task') {
            taskID = input.value;
        }
    });
    return taskID;
}

function markAsResolved(taskID) {
    $(taskID).addClass('resolved');
    $(taskID).find(':input').attr('disabled', true).addClass('disabled');
    $(taskID).find('.task-type').text('Resolved');
}

resolved.each(function(){
    markAsResolved(this);
});

function formHasAction(taskForm, action) {
    // checks whether the task form has a 'Resolve' action or not
    var actionExists = false;
    var actionButton = 'button[name="' + action + '"]';
    if (!!$(taskForm).children(actionButton).length) {
        actionExists = true;
    }
    return actionExists;
}

$('button[name="resolve"]').click(function(e){
    e.preventDefault;
    // if the button clicked is the "resolve all" button,
    // then get forms for all the currently checked tasks
    // else,
    // just get the form for the task that owns the button
    var forms = [];
    if ($(this).attr('id') == 'batched-resolve') {
        $(':checked[form=batched]').each(function() {
            var taskForm = $(this).closest('.task').find('form');
            // the form needs to have a resolve action in order to be added
            if (formHasAction(taskForm, 'resolve')) {
                forms.push(taskForm);
            }
        });
    } else {
        forms.push($(this).closest('form'));
    }
    $(forms).each(function(){
        resolve(this);
    });
    return false;
});

$('button[name="reject"]').click(function(e){
    e.preventDefault;
    var forms = [];
    if ($(this).attr('id') == 'batched-reject') {
        $(':checked[form=batched]').each(function() {
            var taskForm = $(this).closest('.task').find('form');
            if (formHasAction(taskForm, 'reject')) {
                forms.push(taskForm);
            }
        });
    } else {
        forms.push($(this).closest('form'));
    }
    $(forms).each(function(){
        console.log($(this));
        reject(this);
    });
    return false;
});

resolved.addClass('collapsed');
tasks.find('header').click(function() {
    $(this).parent().toggleClass('collapsed');
});

$('.task .permalink').click(function(e) {
    e.stopPropagation();
});

$('.task .checkbox').click(function(e) {
    e.stopPropagation();
});

var checkboxes = $('.task header').find(':checkbox');
var batchedButtons = $('#batched button').not('#collapse-all');
batchedButtons.attr('disabled', true);
checkboxes.click(function(){
    if ($('.task header').find(':checkbox:checked').length > 0) {
        batchedButtons.attr('disabled', false);
    } else {
        batchedButtons.attr('disabled', true);
    }
});

$('#collapse-all').click(function(e){
    e.preventDefault();
    if ($(this).text() == "Collapse All") {
        $(this).text("Reveal All");
        $('.task').addClass('collapsed');
    } else {
        $(this).text("Collapse All");
        $('.task').removeClass('collapsed');
    }
});

$('.reveal-extra-context').click(function(e){
    e.preventDefault();
    if ($(this).data['state']) {
        // if on, turn off
        $(this).data['state'] = 0;
        $(this).text("More Info");
        $(this).next().addClass('hidden');
    } else {
        // if off, turn on
        $(this).data['state'] = 1;
        $(this).text("Less Info");
        $(this).next().removeClass('hidden');
    }
});
{% endblock list-scripts %}
