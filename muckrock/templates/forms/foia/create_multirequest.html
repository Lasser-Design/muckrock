{% extends 'forms/base_form.html' %}
{% block title %}MuckRock &bull; Create a multi-request{% endblock %}
{% block form-type %}multirequest-create{% endblock %}
{% block form-title %}Create a multi-request{% endblock form-title %}

{% load static from staticfiles %}

{% block scripts %}
<script src="{% static 'js/jquery.multiselect.js' %}" type="text/javascript"></script>
<script>
    var agencySearch = "<input type='text' class='search-input' id='agency-search' autocomplete='off' placeholder='Search for an agency'>";
    var agencySelect = '#id_agencies';
    $(agencySelect).multiSelect({
        selectableHeader: "<label>All Agencies</label>",
        selectionHeader: "<label>Selected Agencies</label>",
        afterSelect: function(values){
            $(values).each(function(){
                var option = $(agencySelect).children('[value=' + this + ']');
                $(option).attr('selected', true);
            });
        },
        afterDeselect: function(values){
            $(values).each(function(){
                var option = $(agencySelect).children('[value=' + this + ']');
                $(option).attr('selected', false);
            });
        }
    });
    $(agencySearch).insertBefore('#id_agencies');
    $('#agency-search').keypress(function(key){
        var currentKey = String.fromCharCode(key.charCode);
        var query = this.value + currentKey;
        console.log(query);
        $.ajax({
            method: 'GET',
            data: {'query': query},
            dataType: 'json',
            success: function(data, status, xhr){
                console.log(data);

                // first, clear all the currently unselected children
                $(agencySelect).children('option').not(':selected').remove();
                // then, refresh the widget
                $(agencySelect).multiSelect('refresh');
                // finally, load the new data into the widget
                for (var agency in data) {
                    $(agencySelect).multiSelect('addOption', {
                        'text': agency,
                        'value': data[agency],
                    });
                }
            }
        });
    });
</script>
{% endblock scripts %}
