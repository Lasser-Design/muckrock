{% extends 'base.html' %}
{% load static from staticfiles %}

{% block title %}MuckRock &bull; Settings{% endblock title %}

{% block content %}
<article class="account settings">
    <header>
        <a href="{% url 'acct-my-profile' %}">Back to your profile</a>
        <h1>Settings</h1>
        <ul>
            <li><a href="#profile">Profile</a></li>
            <li><a href="#email">Email</a></li>
            <li><a href="#billing">Billing</a></li>
            <li><a href="#password">Change Password</a></li>
        </ul>
    </header>
    <form method="post" action="?type=profile" class="profile form" id="profile">
        {% csrf_token %}
        <h2>Profile</h2>
        <input type="hidden" name="action" value="profile" />
        <div class="fields">
        {% for field in profile_form.visible_fields %}
            <fieldset class="{{ field.label|lower }} field{% if field.field.required %} required{% endif %}">
                <label {% if field.errors %}class="failure"{% endif %} for="{{ field.auto_id }}">{{ field.label}}</label>
                {{ field.errors }}
                {{ field }}
                {% if field.help_text %}<p class="default"><small>{{ field.help_text }}</small></p>{% endif %}
            </fieldset>
        {% endfor %}
        </div>
        <footer>
            <button type="submit" class="primary">Save</button>
        </footer>
    </form>

    <form method="post" class="email form" id="email">
        {% csrf_token %}
        <input type="hidden" name="action" value="email" />
        <h2>Email</h2>
        <div class="fields">
        {% for field in email_form.visible_fields %}
            <fieldset class="{{ field.label|lower }} field{% if field.field.required %} required{% endif %}">
                <label {% if field.errors %}class="failure"{% endif %} for="{{ field.auto_id }}">{{ field.label}}</label>
                {{ field.errors }}
                {{ field }}
                {% if field.help_text %}<p class="default"><small>{{ field.help_text }}</small></p>{% endif %}
                {% if field == form.email %}
                {% if request.user.profile.email_confirmed %}
                <span>Verified</span>
                {% else %}
                <a href="{% url 'acct-verify-email' %}">Verify your email</a>
                {% endif %}
                {% endif %}
            </fieldset>
        {% endfor %}
        </div>
        <footer>
            <button type="submit" class="primary">Save</button>
        </footer>
    </form>

    <form method="post" class="billing form" id="billing">
        {% csrf_token %}
        <input type="hidden" name="action" value="billing" />
        <h2>Billing</h2>
        <button
            data-amount="0"
            data-description="Update Credit Card"
            data-email="{{ request.user.email }}"
            data-label="Update"
            data-form="#billing"
            class="checkout-button primary">
            Update Credit Card
        </button>
        <a href="{% url 'accounts' %}" class="button">Change Plan</a>
    </form>

    <form method="post" class="password form" id="password">
        {% csrf_token %}
        <input type="hidden" name="action" value="password" />
        <h2>Change Password</h2>
        <div class="fields">
        {% for field in password_form.visible_fields %}
            <fieldset class="{{ field.label|lower }} field{% if field.field.required %} required{% endif %}">
                <label {% if field.errors %}class="failure"{% endif %} for="{{ field.auto_id }}">{{ field.label}}</label>
                {{ field.errors }}
                {{ field }}
                {% if field.help_text %}<p class="default"><small>{{ field.help_text }}</small></p>{% endif %}
            </fieldset>
        {% endfor %}
        </div>
        <footer>
            <button type="submit" class="primary">Save</button>
            <a href="{% url 'acct-reset-pw' %}">Forgot your password?</a>
        </footer>
    </form>
</article>
{% endblock %}

{% block scripts %}
    {% include 'autocomplete_light/static.html' %}
    <script src="https://checkout.stripe.com/checkout.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {
        $('.checkout-button').click(function(e){
            e.preventDefault();
            var checkoutData = getCheckoutData($(this));
            checkout(
                "{{ stripe_pk }}",
                "{% static 'apple-touch-icon.png' %}",
                checkoutData.description,
                checkoutData.amount,
                checkoutData.email,
                checkoutData.label,
                checkoutData.form,
                true,
                false
            );
        });
    });
</script>
{% endblock %}
