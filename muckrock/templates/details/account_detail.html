{% extends 'details/base_detail.html' %}
{% load markdown_deux_tags %}
{% load static from staticfiles %}

{% block title %}MuckRock &bull; {{ user_obj.username|capfirst }}{% endblock title %}
{% block type %}profile{% endblock type %}

{% block header %}
    {% ifequal user user_obj %}
    <h2>{{user.get_profile.get_acct_type_display}} Account</h2>
    <h1>{{user_obj.first_name}} {{user_obj.last_name}}</h1>
    <h2>{{user_obj.username}}</h2>
    {% else %}
    <dfn>Profile</dfn>
    <h2>{{user.get_profile.get_acct_type_display}} Account</h2>
    <h1>{{user_obj.first_name}} {{user_obj.last_name}}</h1>
    <h2>{{user_obj.username}}</h2>
    {% endifequal %}
{% endblock header %}

{% block aside %}
    {% if user == user_obj %}
    <dl>
        <dt>Information on File</dt>
        <dd>{{user_obj.email}}</dd>
        {% if user_obj.get_profile.phone %}
        <dd>{{user_obj.get_profile.phone}}</dd>
        {% endif %}
        {% if user_obj.get_profile.address1 or user_obj.get_profile.city %}
            {% if user_obj.get_profile.address1 %}
        <dd>{{ user_obj.get_profile.address1 }}</dd>
                {% if user_obj.get_profile.address2 %}
        <dd>{{ user_obj.get_profile.address2 }}</dd>
                {% endif %}
            {% endif %}
            {% if user_obj.get_profile.city and user_obj.get_profile.state and user_obj.get_profile.zip_code %}
        <dd>{{user_obj.get_profile.city}}, {{user_obj.get_profile.state}}</dd>
        <dd>{{user_obj.get_profile.zip_code}}</dd>
            {% endif %}
        {% endif %}
    
        {% if user_obj.get_profile.get_cc %}
        <dt>Credit Card on File</dt>
        <dd>{{user_obj.get_profile.get_cc.type}} ending with {{user_obj.get_profile.get_cc.last4}}</dd>
        {% endif %}
    </dl>
    {% if user.get_profile.get_acct_type_display != 'Community' %}
    <dl>
        <dt>Monthly Requests</dt>
        {% if user_obj.get_profile.get_monthly_requests %}
        <dd>{{ user_obj.get_profile.get_monthly_requests }}</dd>
        {% else %}
        <dd>0</dd>
        {% endif %}
    </dl>
    {% endif %}
    <dl>        
        <dt>Requests Remaining</dt>
        {% if user_obj.get_profile.num_requests %}
        <dd>{{ user_obj.get_profile.num_requests }}</dd>
        {% else %}
        <dd>0</dd>
        {% endif %}
    </dl>
    {% endif %}
    
{% endblock aside %}

{% block actions %}
{% if request.user == user_obj %}
<form action="{% url 'acct-buy-requests' %}" method="POST" class="controls" id="buy-requests">
    {% csrf_token %}
    <button class="primary" id="buy-requests-button">Buy Requests</button>
    <a href="{% url 'acct-update' %}" class="button">Settings</a>
    <a href="{% url 'acct-change-pw' %}" class="button">Change Password</a>
    <a href="{% url 'acct-manage-subsc' %}" class="button">Manage Subscription</a>
</form>
{% endif %}
{% endblock actions %}

{% block main %}
    
    {% if user == user_obj %}
        {% include 'lib/foia_table.html' with requests=user_obj.get_profile.follows_foia.all title='Requests You Follow' %}
    {% endif %}
    
    {% if recent_requests or recent_completed %}
        {% if recent_requests %}
            {% include 'lib/foia_table.html' with requests=recent_requests title='Latest Requests' %}
        {% endif %}
        {% if recent_completed %}
            {% include 'lib/foia_table.html' with requests=recent_completed title='Recently Completed Requests' %}
        {% endif %}
    {% else %}
        <h3>No requests have been filed. <small><a href="{% url 'foia-create'%}">Create one now.</a></small></h3>
    {% endif %}
    
{% endblock main %}

{% block scripts %}
{% if request.user == user_obj %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>

    $(document).ready(function() {
        $('#buy-requests-button').click(function(e){
            e.preventDefault();
            
            var form = $(this).parent();
            var token = function(token) {
                form.append('<input type="hidden" name="stripe_token" value="' + token.id + '" />');
                form.append('<input type="hidden" name="stripe_email" value="' + token.email + '" />');
                form.submit();
                
            }
            
            StripeCheckout.open({
                key: "{{ stripe_pk }}",
                image: "{% static 'apple-touch-icon.png' %}",
                name: 'MuckRock',
                description: '5 requests ($20.00)',
                amount: 2000,
                email: '{{ request.user.email }}',
                token: token
            });
        });
    });
</script>
{% endif %}
{% endblock scripts %}